
<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>ุณุญุจ ุฑูู ุงููุฑุญ</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="/_sdk/element_sdk.js"></script>
<script src="/_sdk/data_sdk.js"></script>
</head>

<body class="bg-[#800020] min-h-screen flex items-center justify-center p-4">

<div id="app" class="bg-white w-full max-w-md rounded-xl p-6 text-center">

  <h1 id="shopName" class="text-2xl font-bold mb-2">
    ูุคุณุณุฉ ุฑูู ุงููุฑุญ ููุฎูุงุทุฉ
  </h1>

  <p id="welcomeMsg" class="mb-2">
    ุฃููุงู ุจูู ูู ุงูุชุชุงุญูุง ุงููุจูุฑ ๐
  </p>

  <p id="prizeText" class="font-semibold text-amber-700 mb-4">
    ุณุฌูู ุงูุขู ูุงุฑุจุญ ุฌูุงุฆุฒ ููููุฉ!
  </p>

  <form id="form" class="space-y-3">

    <input
      id="nameInput"
      class="w-full border rounded p-2"
      placeholder="ุงูุงุณู ุงููุงูู"
      required
    >

    <div class="flex gap-2">
      <div class="border rounded p-2 bg-gray-100">+966</div>
      <input
        id="phoneInput"
        class="flex-1 border rounded p-2"
        placeholder="5XXXXXXXX"
        required
      >
    </div>

    <button
      class="w-full bg-yellow-400 py-2 rounded font-bold">
      ุณุฌูู ุงูุขู
    </button>

  </form>

  <p class="mt-4 font-bold">
    ุนุฏุฏ ุงููุดุงุฑููู:
    <span id="count">0</span>
  </p>

</div>

<script>
/* ===== ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ ูููุงููุง ===== */

const defaultConfig = {
  shop_name: "ูุคุณุณุฉ ุฑูู ุงููุฑุญ ููุฎูุงุทุฉ",
  welcome_message: "ุฃููุงู ุจูู ูู ุงูุชุชุงุญูุง ุงููุจูุฑ ๐",
  prize_text: "ุณุฌูู ุงูุขู ูุงุฑุจุญ ุฌูุงุฆุฒ ููููุฉ!"
};

let participants = [];

/* ===== ุชุญุฏูุซ ุงููุตูุต ูู ููุญุฉ Canva ===== */

function onConfigChange(cfg){
  document.getElementById("shopName").textContent =
    cfg.shop_name || defaultConfig.shop_name;

  document.getElementById("welcomeMsg").textContent =
    cfg.welcome_message || defaultConfig.welcome_message;

  document.getElementById("prizeText").textContent =
    cfg.prize_text || defaultConfig.prize_text;
}

/* ===== ุงุณุชูุจุงู ุงูุจูุงูุงุช ูู Data SDK ===== */

const dataHandler = {
  onDataChanged(data){
    participants = data || [];
    document.getElementById("count").textContent =
      participants.length;
  }
};

/* ===== ุชููุฆุฉ Canva SDK ===== */

if(window.elementSdk){
  window.elementSdk.init({
    defaultConfig,
    onConfigChange,
    mapToEditPanelValues:(cfg)=> new Map([
      ["shop_name", cfg.shop_name || defaultConfig.shop_name],
      ["welcome_message", cfg.welcome_message || defaultConfig.welcome_message],
      ["prize_text", cfg.prize_text || defaultConfig.prize_text]
    ])
  });
}

/* ===== ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ===== */

(async()=>{
  if(window.dataSdk){
    await window.dataSdk.init(dataHandler);
  }
})();

/* ===== ูุญุต ุงูุชูุฑุงุฑ ===== */

function isRegistered(phone){
  return participants.some(p => p.phone === phone);
}

/* ===== ุชุณุฌูู ูุดุงุฑู ===== */

document.getElementById("form").addEventListener("submit", async (e)=>{
  e.preventDefault();

  const name  = nameInput.value.trim();
  const phone = phoneInput.value.replace(/\D/g,'');

  if(!name || !phone){
    alert("ูุฑุฌู ุฅุฏุฎุงู ุงูุจูุงูุงุช");
    return;
  }

  if(phone.length < 9){
    alert("ุฑูู ุบูุฑ ุตุญูุญ");
    return;
  }

  if(isRegistered(phone)){
    alert("ูุฐุง ุงูุฑูู ูุณุฌู ูุณุจูุงู");
    return;
  }

  const record = {
    id: Date.now().toString(),
    name,
    phone,
    registeredAt: new Date().toISOString(),
    isWinner:false
  };

  const res = await dataSdk.create(record);

  if(res && res.isOk){
    alert("ุชู ุงูุชุณุฌูู ุจูุฌุงุญ ๐");
    e.target.reset();
  }else{
    alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ");
  }

});
</script>

</body>
</html>
